# Copilot 系统设定与上下文说明

## 核心约束

- **语言要求**：在此仓库的所有对话、代码注释、Commit Message、PR 描述等，必须 100% 使用中文输出。
- **重构基准**：在重构核心逻辑（如发牌、出牌校验、计分、进贡、升级等）时，必须以本文档提供的规则为唯一事实来源（Source of Truth），若现有代码与此冲突，请覆盖重写现有代码。

## 领域驱动设计（DDD）及业务规则建模指南

为了方便重构，请仔细阅读并理解以下"大连打滚子"的核心业务规则，在重写领域模型（Domain Models）时严格遵守：

### 1. 核心常量与牌型限制

- **卡牌总数**：3副牌，共 162 张。
- **玩家数量**：4人，每人 39 张，底牌 6 张。
- **特殊牌型定义**：
  - 棒子（对子）：2张相同花色且相同点数的牌（如2张红桃5）。
  - 滚子（三条）：3张相同花色且相同点数的牌（如3张红桃5）。
- **【极其重要】出牌限制**：
  - 绝对禁止出顺子（如34567）、拖拉机/连对（如3344）和泰坦尼克/连三条（如555666）。
  - 绝对禁止甩牌。

### 2. 核心状态机与阶段

游戏流转必须包含以下阶段，并在状态机中严格管控：

- **发牌（Dealing）**：分发 162 张牌。
- **叫主（Calling Trump）**：
  - 首局：必须有大王才能叫主。
  - 非首局：必须有2张或以上当前级别的主牌才能叫主。
- **埋底/扣王（Burying Cards）**：庄家拿 6 张底牌，并重新埋入 6 张。允许扣王（将王牌埋入底牌）。
- **出牌（Playing）**：必须跟领出的花色，没有该花色才能垫牌。主牌最大者赢下该墩。
- **计分（Scoring）**：基础分值：5=5分，10=10分，K=10分。单局总分 = 300分。
- **结算进贡与升级（Settlement）**：计算双方分数与惩罚。

### 3. 计分与升级计算公式

当前局由庄家（跑分方）与闲家（抓分方）对抗。120分为核心分水岭。

**分数判定**：

- 若闲家得分 < 120 分：庄家队升级。
- 若闲家得分 ≥ 120 分：闲家队升级（同时触发反庄，闲家变庄家）。
- 若闲家得分 ≥ 120 分 且 最后一回合抠底：闲家在常规升级基础上，额外再升1级。

**扣王加成（Joker Bonus）**：

- 扣大王：附带 2 级 / 2 血。
- 扣小王：附带 1 级 / 1 血。
- 扣王后升的级数直接叠加给胜利方（注：若扣王方失败，即"扣王失败"，不但不加级，还要进行额外的进贡惩罚）。

### 4. 进贡/喝血规则

进贡在下一局发牌前执行，贡牌从手牌中最大的牌开始上给上一局的赢家（或庄家）。计算公式包含两部分：

**分数惩罚差（针对闲家/抓分方表现）**：

- 极差（低于80分）：每少10分，闲家下轮多进1个贡。（例：70分进1贡，0分进8贡）。
- 极好（大于150分）：从150分起，每多10分，多吃庄家1个血/贡。

**扣王失败惩罚**：

- 庄家扣王但闲家得分 ≥ 120；或闲家扣王但得分 < 120。
- 惩罚代价：1张扣下的大王 = 进2张贡；1张扣下的小王 = 进1张贡。下一局由扣王失败的玩家进给胜利方。

## 工作要求

请基于上述规则理解，在后续的每一个指令中，首先核对上述规则，并确保重构后的类结构、校验器（Validator）和计分服务（Scoring Service）完全符合大连打滚子的规范。在后续的所有对话和代码重构中保持使用中文。
